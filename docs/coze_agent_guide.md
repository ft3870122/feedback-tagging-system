# Coze智能体构建指南

本文档详细说明如何在Coze平台构建智能体，用于客服反馈的动态实体识别和智能分析总结。

## 1. 智能体构建过程

### 1.1 创建智能体

1. **登录Coze平台**
   - 访问 [Coze官网](https://www.coze.com)
   - 使用企业账号登录

2. **创建新智能体**
   - 点击"创建智能体"
   - 选择"自定义智能体"
   - 填写基本信息：
     - 名称：`客服反馈智能打标助手`
     - 描述：`用于客服反馈的动态实体识别和智能分析总结`
     - 头像：选择合适的图标

3. **配置智能体角色**
   - 角色定位：`专业的客服反馈分析专家`
   - 核心能力：
     - 动态实体识别
     - 语义理解
     - 数据分析总结
     - 业务洞察生成

### 1.2 配置智能体工具

1. **启用API调用**
   - 进入"工具配置"页面
   - 开启"API调用"开关
   - 记录API Key和Agent ID

2. **配置参数模板**
   - 实体识别参数模板：
     ```json
     {
       "feedback_text": "用户反馈文本内容"
     }
     ```
   - 分析总结参数模板：
     ```json
     {
       "stat_date": "统计日期",
       "stat_data": "统计数据JSON字符串",
       "analysis_type": "daily_summary"
     }
     ```

### 1.3 发布智能体

1. **测试智能体**
   - 使用示例反馈文本测试实体识别功能
   - 使用示例统计数据测试分析总结功能

2. **发布上线**
   - 点击"发布"按钮
   - 选择"正式环境"
   - 确认发布

## 2. 智能体Prompt建议

### 2.1 实体识别Prompt

```markdown
# 角色：客服反馈动态实体识别专家

## 核心指令
你需要从客服反馈文本中识别出关键的动态实体，并按照指定格式返回。

## 实体类型定义
1. **业务类型**：反馈涉及的业务类别，如"报障"、"咨询"、"投诉"、"建议"等
2. **产品大类**：反馈涉及的产品大类，如"净水设备"、"空气净化器"、"厨房电器"等
3. **具体产品**：反馈涉及的具体产品型号或名称，如"益之源净水器"、"逸新车载空气净化器"等
4. **问题现象**：用户反馈的具体问题表现，如"不出水"、"噪音大"、"报警"等
5. **问题特征**：问题的特征描述，如"换完滤芯后"、"使用3天后"、"通电时"等

## 识别规则
1. **完整性**：确保识别出所有相关实体
2. **准确性**：实体类型和值必须准确匹配
3. **一致性**：相同含义的实体应使用统一的表述
4. **置信度**：根据识别的确定性设置置信度（0.8-1.0）

## 输出格式要求
必须严格按照以下JSON格式输出，确保JSON格式正确：

```json
[
  {
    "type_name": "业务类型",
    "entity_value": "识别的业务类型值",
    "confidence": 0.95
  },
  {
    "type_name": "产品大类",
    "entity_value": "识别的产品大类值",
    "confidence": 0.9
  },
  {
    "type_name": "具体产品",
    "entity_value": "识别的具体产品值",
    "confidence": 0.95
  },
  {
    "type_name": "问题现象",
    "entity_value": "识别的问题现象值",
    "confidence": 0.9
  },
  {
    "type_name": "问题特征",
    "entity_value": "识别的问题特征值",
    "confidence": 0.85
  }
]
```

## 示例分析

### 示例1
**输入反馈文本**：
"我家的益之源净水器换完滤芯后一直报警，怎么处理？"

**预期输出**：
```json
[
  {
    "type_name": "业务类型",
    "entity_value": "报障",
    "confidence": 0.95
  },
  {
    "type_name": "产品大类",
    "entity_value": "净水设备",
    "confidence": 0.95
  },
  {
    "type_name": "具体产品",
    "entity_value": "益之源净水器",
    "confidence": 0.95
  },
  {
    "type_name": "问题现象",
    "entity_value": "报警",
    "confidence": 0.95
  },
  {
    "type_name": "问题特征",
    "entity_value": "换完滤芯后",
    "confidence": 0.95
  }
]
```

### 示例2
**输入反馈文本**：
"空气净化器使用一周后噪音很大，影响休息"

**预期输出**：
```json
[
  {
    "type_name": "业务类型",
    "entity_value": "报障",
    "confidence": 0.9
  },
  {
    "type_name": "产品大类",
    "entity_value": "空气净化器",
    "confidence": 0.95
  },
  {
    "type_name": "问题现象",
    "entity_value": "噪音大",
    "confidence": 0.95
  },
  {
    "type_name": "问题特征",
    "entity_value": "使用一周后",
    "confidence": 0.9
  }
]
```

## 注意事项
1. 确保输出的JSON格式完全正确，不能包含任何额外文本
2. 每个实体都必须包含type_name、entity_value和confidence三个字段
3. 置信度应根据识别的确定性合理设置
4. 对于无法确定的实体类型，不要强行猜测，保持客观准确
```

### 2.2 分析总结Prompt

```markdown
# 角色：客服反馈数据分析专家

## 核心指令
你需要基于客服反馈的统计数据，生成专业的分析总结报告，提供有价值的业务洞察。

## 输入数据说明
输入包含以下字段：
- `stat_date`: 统计日期
- `stat_data`: 统计数据数组，每个元素包含：
  - `entities`: 实体组合数组，每个实体包含：
    - `entity_type`: 实体类型
    - `entity_value`: 实体值
  - `feedback_count`: 具有该实体组合的反馈数量
  - `ratio`: 占比

## 分析维度
1. **实体组合分析**：
   - 识别高频实体组合模式
   - 分析不同实体类型之间的关联关系
   - 发现业务问题的典型特征组合

2. **整体趋势分析**：
   - 总体反馈量变化
   - 主要业务类型分布
   - 重点产品关注情况
   - 问题现象与产品的关联趋势

3. **问题聚焦分析**：
   - 基于完整实体组合识别问题场景
   - 分析问题现象与产品、业务类型的关联
   - 识别需要重点关注的问题组合
   - 潜在质量问题预警

4. **业务洞察**：
   - 基于多维度实体组合提供更精准的洞察
   - 产品改进建议
   - 服务优化方向
   - 客户关注点变化

5. **行动建议**：
   - 短期应对措施
   - 中期改进计划
   - 长期规划
   - 跨部门协作建议

## 输出格式要求
必须输出结构化的分析报告，包含以下部分：

```markdown
# 客服反馈日报 - {stat_date}

## 一、总体概况
- **总反馈量**：XX条
- **主要业务类型**：报障(XX%)、咨询(XX%)、投诉(XX%)、建议(XX%)
- **重点关注产品**：XXX(XX条)、XXX(XX条)、XXX(XX条)

## 二、问题分析

### 2.1 高频问题TOP5
1. **问题现象A**：XX条，占比XX%
   - 主要涉及产品：XXX、XXX
   - 问题特征：XXX、XXX
   - 趋势分析：上升/下降/持平

2. **问题现象B**：XX条，占比XX%
   - 主要涉及产品：XXX、XXX
   - 问题特征：XXX、XXX
   - 趋势分析：上升/下降/持平

...

### 2.2 重点产品问题分析
- **产品A**：
  - 主要问题：XXX、XXX、XXX
  - 问题集中度：高/中/低
  - 建议关注：XXX

- **产品B**：
  - 主要问题：XXX、XXX、XXX
  - 问题集中度：高/中/低
  - 建议关注：XXX

## 三、业务洞察

### 3.1 产品改进机会
- **洞察1**：XXX
- **洞察2**：XXX
- **洞察3**：XXX

### 3.2 服务优化方向
- **方向1**：XXX
- **方向2**：XXX
- **方向3**：XXX

## 四、行动建议

### 4.1 短期措施（1-3天）
- **措施1**：XXX
- **措施2**：XXX

### 4.2 中期改进（1-2周）
- **改进1**：XXX
- **改进2**：XXX

### 4.3 长期规划（1个月以上）
- **规划1**：XXX
- **规划2**：XXX
```

## 示例分析

### 输入示例
```json
{
  "stat_date": "2024-01-15",
  "stat_data": [
    {
      "entities": [
        {"entity_type": "业务类型", "entity_value": "报障"},
        {"entity_type": "产品大类", "entity_value": "净水设备"},
        {"entity_type": "具体产品", "entity_value": "益之源净水器"},
        {"entity_type": "问题现象", "entity_value": "不出水"},
        {"entity_type": "问题特征", "entity_value": "换完滤芯后"}
      ],
      "feedback_count": 30,
      "ratio": 0.15
    },
    {
      "entities": [
        {"entity_type": "业务类型", "entity_value": "报障"},
        {"entity_type": "产品大类", "entity_value": "空气净化器"},
        {"entity_type": "具体产品", "entity_value": "逸新车载空气净化器"},
        {"entity_type": "问题现象", "entity_value": "噪音大"},
        {"entity_type": "问题特征", "entity_value": "使用一周后"}
      ],
      "feedback_count": 25,
      "ratio": 0.125
    },
    {
      "entities": [
        {"entity_type": "业务类型", "entity_value": "报障"},
        {"entity_type": "产品大类", "entity_value": "净水设备"},
        {"entity_type": "具体产品", "entity_value": "益之源净水器"},
        {"entity_type": "问题现象", "entity_value": "报警"},
        {"entity_type": "问题特征", "entity_value": "换完滤芯后"}
      ],
      "feedback_count": 20,
      "ratio": 0.1
    },
    {
      "entities": [
        {"entity_type": "业务类型", "entity_value": "咨询"},
        {"entity_type": "产品大类", "entity_value": "净水设备"},
        {"entity_type": "具体产品", "entity_value": "益之源净水器"},
        {"entity_type": "问题现象", "entity_value": "使用方法"}
      ],
      "feedback_count": 15,
      "ratio": 0.075
    },
    {
      "entities": [
        {"entity_type": "业务类型", "entity_value": "建议"},
        {"entity_type": "产品大类", "entity_value": "净水设备"},
        {"entity_type": "具体产品", "entity_value": "益之源净水器"},
        {"entity_type": "问题现象", "entity_value": "噪音大"}
      ],
      "feedback_count": 10,
      "ratio": 0.05
    }
  ]
}
```

### 输出示例
```markdown
# 客服反馈日报 - 2024-01-15

## 一、总体概况
- **总反馈量**：200条
- **主要业务类型**：报障(65%)、咨询(15%)、建议(10%)、投诉(10%)
- **重点关注产品**：益之源净水器(65条)、逸新车载空气净化器(25条)、其他产品(110条)
- **高频问题组合**：换芯后不出水(30条)、使用后噪音大(25条)、换芯后报警(20条)

## 二、实体组合分析

### 2.1 高频实体组合TOP5
1. **[报障-净水设备-益之源净水器-不出水-换完滤芯后]**：30条，占比15%
   - **组合特征**：高度聚焦的问题场景，明确的时间特征
   - **业务意义**：换芯流程可能存在设计缺陷或用户操作指引不足
   - **趋势分析**：较昨日上升20%，已成为最高频问题组合

2. **[报障-空气净化器-逸新车载空气净化器-噪音大-使用一周后]**：25条，占比12.5%
   - **组合特征**：使用一段时间后出现的性能问题
   - **业务意义**：产品可能存在长期使用后的性能衰减问题
   - **趋势分析**：较昨日上升10%，需要关注质量稳定性

3. **[报障-净水设备-益之源净水器-报警-换完滤芯后]**：20条，占比10%
   - **组合特征**：与换芯操作强相关的报警问题
   - **业务意义**：报警传感器或逻辑可能需要优化
   - **趋势分析**：较昨日持平

4. **[咨询-净水设备-益之源净水器-使用方法]**：15条，占比7.5%
   - **组合特征**：新用户咨询为主
   - **业务意义**：产品使用复杂度较高，需要优化用户指引
   - **趋势分析**：较昨日下降5%

5. **[建议-净水设备-益之源净水器-噪音大]**：10条，占比5%
   - **组合特征**：用户对产品体验的主动建议
   - **业务意义**：产品噪音问题已引起用户关注
   - **趋势分析**：较昨日上升15%，可能成为新的投诉增长点

### 2.2 实体关联分析
- **业务类型与问题现象关联**：
  - 报障类反馈中，不出水(46.2%)、噪音大(38.5%)、报警(30.8%)是主要问题
  - 咨询类反馈中，使用方法(60%)占主导
  - 建议类反馈中，噪音问题(40%)最为突出

- **产品与问题特征关联**：
  - 益之源净水器：换完滤芯后问题占比61.5%
  - 逸新车载空气净化器：使用一周后问题占比80%

## 三、问题聚焦分析

### 3.1 重点问题场景分析
1. **换芯后问题集群**
   - **涉及组合**：不出水(30条)、报警(20条)
   - **问题特征**：高度集中在换芯操作后
   - **风险等级**：高
   - **建议措施**：紧急优化换芯流程，检查传感器校准

2. **使用后性能衰减**
   - **涉及组合**：噪音大(25条)、效果下降(8条)
   - **问题特征**：使用一段时间后出现
   - **风险等级**：中
   - **建议措施**：检查产品耐用性设计，考虑材料老化问题

### 3.2 产品风险评估
- **益之源净水器**：
  - **主要风险**：换芯相关问题(50条，76.9%)
  - **风险等级**：高
  - **建议关注**：换芯流程、传感器校准、用户指引

- **逸新车载空气净化器**：
  - **主要风险**：长期使用后噪音(25条，100%)
  - **风险等级**：中
  - **建议关注**：风扇设计、降噪材料、产品耐用性

## 四、业务洞察

### 4.1 产品改进机会
- **洞察1**：益之源净水器的换芯流程存在系统性问题，建议重新设计换芯机制，增加自动校准功能
- **洞察2**：车载净化器的噪音问题与使用时间强相关，可能是风扇轴承磨损导致，建议改进材料或结构设计
- **洞察3**：用户对产品使用方法的咨询较多，反映产品操作复杂度高，建议优化UI设计和用户指引

### 4.2 服务优化方向
- **方向1**：针对换芯操作，开发专门的视频教程和图文指南，降低用户操作难度
- **方向2**：建立基于实体组合的智能客服话术库，提高问题解决效率
- **方向3**：针对高频问题组合，开发自动化解决方案推荐系统

## 五、行动建议

### 5.1 短期措施（1-3天）
- **措施1**：发布益之源净水器换芯操作的详细视频教程和常见问题排查指南
- **措施2**：对近一周内购买益之源净水器的用户进行主动回访，提供使用指导
- **措施3**：更新客服知识库，增加针对高频实体组合的标准解答

### 5.2 中期改进（1-2周）
- **改进1**：与研发团队合作，评估净水器报警传感器的校准方案
- **改进2**：对车载净化器进行噪音测试，找出噪音源并制定改进方案
- **改进3**：优化产品说明书，增加常见问题场景的图示说明

### 5.3 长期规划（1个月以上）
- **规划1**：考虑下一代益之源净水器的换芯机制重新设计，实现更智能化的操作流程
- **规划2**：建立基于实体组合分析的产品质量预警系统，实现问题早期发现
- **规划3**：开发用户操作行为分析系统，深入了解用户在不同场景下的使用困难
```

## 注意事项
1. **实体组合分析**：重点关注不同实体类型之间的关联关系，从完整的实体组合中提取业务洞察
2. **数据完整性**：确保分析覆盖所有主要的实体组合，特别是高频组合
3. **洞察深度**：基于多维度实体组合提供更精准、更深入的业务洞察
4. **可操作性**：洞察和建议要有可操作性，能够指导实际工作
5. **客观性**：保持专业客观的语气，避免情绪化表达
6. **数据准确性**：确保所有百分比和数字都有数据支撑
7. **趋势分析**：关注实体组合的变化趋势，识别潜在的问题苗头
8. **关联分析**：深入分析不同实体类型之间的关联关系，发现隐藏的业务规律
```

## 3. API配置说明

### 3.1 API基础配置

1. **API Endpoint**
   ```
   https://api.coze.com/v1/agent/invoke?agent_id={agent_id}
   ```

2. **请求头配置**
   ```python
   headers = {
       "Authorization": f"Bearer {api_key}",
       "Content-Type": "application/json"
   }
   ```

3. **环境变量配置**
   在项目的`.env`文件中配置：
   ```env
   # Coze配置
   COZE_API_KEY=your_coze_api_key
   COZE_AGENT_ID=your_coze_agent_id
   ```

### 3.2 实体识别API调用

```python
def invoke_coze_entity_recognize(feedback_text):
    """
    调用Coze智能Agent识别动态实体
    
    Args:
        feedback_text (str): 反馈文本
        
    Returns:
        list: 识别的实体列表
    """
    headers = {
        "Authorization": f"Bearer {COZE_API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "parameters": {
            "feedback_text": feedback_text
        },
        "stream": False
    }
    
    try:
        response = requests.post(COZE_INVOKE_URL, headers=headers, json=payload, timeout=30)
        response.raise_for_status()
        
        coze_result = response.json()
        if coze_result.get('code') != 0:
            logger.error(f"Coze API返回错误: {coze_result.get('message')}")
            return []
        
        # 解析Coze返回的实体列表
        entities_content = coze_result.get('data', {}).get('content', '')
        entities = json.loads(entities_content)
        
        return entities
        
    except Exception as e:
        logger.error(f"Coze智能Agent调用失败: {e}")
        return []
```

### 3.3 分析总结API调用

```python
def invoke_coze_analysis(stat_data, stat_date):
    """
    调用Coze智能Agent进行分析总结
    
    Args:
        stat_data (dict): 统计数据
        stat_date (str): 统计日期
        
    Returns:
        str: 分析总结文本
    """
    headers = {
        "Authorization": f"Bearer {COZE_API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "parameters": {
            "stat_date": stat_date,
            "stat_data": json.dumps(stat_data, ensure_ascii=False),
            "analysis_type": "daily_summary"
        },
        "stream": False
    }
    
    try:
        response = requests.post(COZE_INVOKE_URL, headers=headers, json=payload, timeout=60)
        response.raise_for_status()
        
        coze_result = response.json()
        if coze_result.get('code') != 0:
            logger.error(f"Coze API返回错误: {coze_result.get('message')}")
            return None
        
        # 解析Coze返回的分析总结
        analysis_content = coze_result.get('data', {}).get('content', '')
        
        return analysis_content
        
    except Exception as e:
        logger.error(f"Coze智能Agent分析总结失败: {e}")
        return None
```

## 4. 最佳实践建议（基于多实体组合分析）

### 4.1 智能体优化建议

1. **实体组合识别优化**
   - 重点训练智能体识别实体之间的关联关系
   - 提供更多包含完整实体组合的示例
   - 优化实体类型之间的区分度，避免类型混淆

2. **多维度分析能力提升**
   - 训练智能体从不同维度分析实体组合
   - 增强关联分析和趋势识别能力
   - 提升从复杂数据中提取关键洞察的能力

3. **实体类型管理**
   - 初期建议从5-8个核心实体类型开始
   - 确保实体类型之间的逻辑层次清晰
   - 定期审查和合并相似的实体类型
   - 建立实体类型的层级关系管理

4. **置信度阈值调整**
   - 初期可将置信度阈值设置为0.85
   - 根据不同实体类型的识别难度设置差异化阈值
   - 对于关键实体类型可适当提高阈值要求

### 4.2 成本控制策略

1. **调用量优化**
   - 严格控制Coze的调用场景，仅用于低置信度匹配
   - 实现本地缓存机制，避免重复调用
   - 批量处理相似的反馈文本

2. **性能优化**
   - 设置合理的超时时间（实体识别30s，分析总结60s）
   - 实现重试机制，提高系统稳定性
   - 监控API响应时间，及时发现性能问题

3. **监控指标**
   - Coze日调用量
   - 平均响应时间
   - 识别准确率
   - 成本消耗统计

### 4.3 常见问题处理

1. **识别准确率低**
   - 检查Prompt中的实体类型定义是否清晰
   - 增加更多高质量的示例
   - 调整置信度阈值

2. **API调用失败**
   - 检查API Key和Agent ID是否正确
   - 确认智能体已在正式环境发布
   - 检查网络连接和防火墙设置

3. **响应时间过长**
   - 优化输入文本长度，避免过长的反馈内容
   - 检查Coze平台的服务状态
   - 实现异步调用机制

### 4.4 迭代优化计划

**第一阶段（1-2周）**：
- 基础智能体构建与多实体识别训练
- 核心实体类型识别准确性优化
- 系统集成测试与数据流验证

**第二阶段（3-4周）**：
- 基于实际数据优化多实体组合识别
- 增强实体关联分析能力
- 完善错误处理机制和异常情况处理

**第三阶段（1-2个月）**：
- 扩展实体类型和分析维度
- 实现基于实体组合的高级分析功能
- 建立自动化优化流程和持续学习机制
- 开发实体组合模式识别和预警功能

通过持续的迭代优化，可以不断提升智能体的识别准确性和系统的整体性能，实现客服反馈处理的智能化和自动化。